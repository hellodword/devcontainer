name: 'Test'
on:
    push:
        branches:
            - 'master'
    workflow_dispatch:

jobs:
    test-autogenerated:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                features:
                    - common
                    - common-gui
                    - flutter
                baseImage:
                    - mcr.microsoft.com/devcontainers/base:ubuntu-22.04
        steps:
            - name: prepare 1000:1000
              run: |
                set -x
                cat /etc/group
                cat /etc/passwd
                id
                sudo id

            - uses: actions/checkout@v4

            - name: prepare for tests
              run: |
                bash prepare-for-tests.sh

            - name: 'Install latest devcontainer CLI'
              run: sudo npm install -g @devcontainers/cli

            - name: "Generating tests for '${{ matrix.features }}' against '${{ matrix.baseImage }}'"
              run: sudo devcontainer features test --skip-scenarios -f ${{ matrix.features }} -i ${{ matrix.baseImage }} -u vscode .

    test-scenarios:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                features:
                    - android-sdk
                    - flutter
        steps:
            - name: prepare 1000:1000
              run: |
                set -x
                cat /etc/group
                cat /etc/passwd
                id
                sudo id

            - uses: actions/checkout@v4

            - name: prepare for tests
              run: |
                bash prepare-for-tests.sh

            - name: 'Install latest devcontainer CLI'
              run: sudo npm install -g @devcontainers/cli

            - name: "Generating tests for '${{ matrix.features }}' scenarios"
              run: sudo devcontainer features test -f ${{ matrix.features }} --skip-autogenerated --skip-duplicated -u vscode .
